<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  ã€PWAå­¦ä¹ ä¸å®è·µã€‘(8)ä½¿ç”¨Service Workerè¿›è¡Œåå°åŒæ­¥ - Background Sync - AlienZHOU's blog
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="AlienZHOU's blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">AlienZHOU's blog</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; AlienZHOU's blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>PWA</label></li>

          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(9)ç”Ÿäº§ç¯å¢ƒä¸­PWAå®è·µçš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" href="15288038664515.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(9)ç”Ÿäº§ç¯å¢ƒä¸­PWAå®è·µçš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(8)ä½¿ç”¨Service Workerè¿›è¡Œåå°åŒæ­¥ - Background Sync" href="15288038009038.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(8)ä½¿ç”¨Service Workerè¿›è¡Œåå°åŒæ­¥ - Background Sync</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(7)ä½¿ç”¨Notification APIæ¥è¿›è¡Œæ¶ˆæ¯æé†’" href="15288036503920.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(7)ä½¿ç”¨Notification APIæ¥è¿›è¡Œæ¶ˆæ¯æé†’</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(6) åœ¨Chromeä¸­è°ƒè¯•ä½ çš„PWA" href="15288035758780.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(6) åœ¨Chromeä¸­è°ƒè¯•ä½ çš„PWA</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(5)åœ¨Webä¸­è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€" href="15288030176091.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(5)åœ¨Webä¸­è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(4) è§£å†³FireBase loginéªŒè¯å¤±è´¥é—®é¢˜" href="15235166926023.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(4) è§£å†³FireBase loginéªŒè¯å¤±è´¥é—®é¢˜</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(3) è®©ä½ çš„WebAppç¦»çº¿å¯ç”¨" href="15235151669706.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(3) è®©ä½ çš„WebAppç¦»çº¿å¯ç”¨</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(2) ä½¿ç”¨Manifestï¼Œè®©ä½ çš„WebAppæ›´â€œNativeâ€" href="15235140795593.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(2) ä½¿ç”¨Manifestï¼Œè®©ä½ çš„WebAppæ›´â€œNativeâ€</a></li>
          
            <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(1) 2018ï¼Œå¼€å§‹ä½ çš„PWAå­¦ä¹ ä¹‹æ—…" href="15235138633619.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(1) 2018ï¼Œå¼€å§‹ä½ çš„PWAå­¦ä¹ ä¹‹æ—…</a></li>
          

      
        <li class="divider"></li>
        <li><label>React</label></li>

          
            <li><a title="åŸºäºreactæŠ€æœ¯æ ˆçš„å•é¡µåº”ç”¨(SPA)æ­å»º_å¿«é€Ÿå…¥é—¨å®è·µ" href="15236392559880.html">åŸºäºreactæŠ€æœ¯æ ˆçš„å•é¡µåº”ç”¨(SPA)æ­å»º_å¿«é€Ÿå…¥é—¨å®è·µ</a></li>
          
            <li><a title="åœ¨react-router4ä¸­è¿›è¡Œä»£ç æ‹†åˆ†ï¼ˆåŸºäºwebpackï¼‰" href="15235187668595.html">åœ¨react-router4ä¸­è¿›è¡Œä»£ç æ‹†åˆ†ï¼ˆåŸºäºwebpackï¼‰</a></li>
          

      
        <li class="divider"></li>
        <li><label>CSS</label></li>

          
            <li><a title="ã€CSSæ¨¡å—åŒ–ã€‘(3) ä½¿ç”¨ğŸ’…styled-componentsæ¥ä¼˜åŒ–reactç»„ä»¶å¼€å‘" href="15236398426783.html">ã€CSSæ¨¡å—åŒ–ã€‘(3) ä½¿ç”¨ğŸ’…styled-componentsæ¥ä¼˜åŒ–reactç»„ä»¶å¼€å‘</a></li>
          
            <li><a title="ã€CSSæ¨¡å—åŒ–ã€‘(2) BEMå‘½åæ–¹æ³•è®ºâ€”â€”ä½¿ç”¨BEM-constructoræ„å»ºCSS" href="15236396803035.html">ã€CSSæ¨¡å—åŒ–ã€‘(2) BEMå‘½åæ–¹æ³•è®ºâ€”â€”ä½¿ç”¨BEM-constructoræ„å»ºCSS</a></li>
          
            <li><a title="ã€CSSæ¨¡å—åŒ–ã€‘(1) webpackä¹‹Local Scope" href="15236395841604.html">ã€CSSæ¨¡å—åŒ–ã€‘(1) webpackä¹‹Local Scope</a></li>
          

      
        <li class="divider"></li>
        <li><label>Server</label></li>

          
            <li><a title="ã€MongoDBé«˜å¯ç”¨ã€‘å¤åˆ¶é›†Replica Setä½¿ç”¨ç®€ä»‹" href="15236400113573.html">ã€MongoDBé«˜å¯ç”¨ã€‘å¤åˆ¶é›†Replica Setä½¿ç”¨ç®€ä»‹</a></li>
          

      
        <li class="divider"></li>
        <li><label>Automation</label></li>

          
            <li><a title="Gulp.jså®è·µè¯¦è§£__åŸºäºGulpçš„å¤šé¡µé¢åº”ç”¨å®è·µæŒ‡å—" href="15236401468681.html">Gulp.jså®è·µè¯¦è§£__åŸºäºGulpçš„å¤šé¡µé¢åº”ç”¨å®è·µæŒ‡å—</a></li>
          

      
        <li class="divider"></li>
        <li><label>FE else</label></li>

          
            <li><a title="å„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹ï¼ˆPolling/COMET/SSE/WebSocketï¼‰" href="15288039493853.html">å„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹ï¼ˆPolling/COMET/SSE/WebSocketï¼‰</a></li>
          
            <li><a title="æµè§ˆå™¨åŒæºç­–ç•¥ä¸ajaxè·¨åŸŸæ–¹æ³•æ±‡æ€»" href="15236404711802.html">æµè§ˆå™¨åŒæºç­–ç•¥ä¸ajaxè·¨åŸŸæ–¹æ³•æ±‡æ€»</a></li>
          
            <li><a title="JavaScriptå¼‚æ­¥ç¼–ç¨‹__â€œå›è°ƒåœ°ç‹±â€çš„ä¸€äº›è§£å†³æ–¹æ¡ˆ" href="15236403350295.html">JavaScriptå¼‚æ­¥ç¼–ç¨‹__â€œå›è°ƒåœ°ç‹±â€çš„ä¸€äº›è§£å†³æ–¹æ¡ˆ</a></li>
          
            <li><a title="jsæ§åˆ¶inputæ¡†å†…å…‰æ ‡ä½ç½®ï¼ˆsetSelectionRangeè¯¦è§£ï¼‰" href="15236405992551.html">jsæ§åˆ¶inputæ¡†å†…å…‰æ ‡ä½ç½®ï¼ˆsetSelectionRangeè¯¦è§£ï¼‰</a></li>
          

      
        <li class="divider"></li>
        <li><label>Reading</label></li>

          
            <li><a title="æ¨èé˜…è¯» 2018.06" href="15288017709756.html">æ¨èé˜…è¯» 2018.06</a></li>
          
            <li><a title="æ¨èé˜…è¯» 2018.05" href="15287963471356.html">æ¨èé˜…è¯» 2018.05</a></li>
          
            <li><a title="æ¨èé˜…è¯» 2018.04" href="15283399559020.html">æ¨èé˜…è¯» 2018.04</a></li>
          
            <li><a title="æ¨èé˜…è¯» 2018.03" href="15282529256902.html">æ¨èé˜…è¯» 2018.03</a></li>
          

      
        <li class="divider"></li>
        <li><label>Performace</label></li>

          
            <li><a title="ã€æ€§èƒ½ä¼˜åŒ–å®è·µã€‘ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦" href="15288037747207.html">ã€æ€§èƒ½ä¼˜åŒ–å®è·µã€‘ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>PWA</span></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(9)ç”Ÿäº§ç¯å¢ƒä¸­PWAå®è·µçš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" href="15288038664515.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(9)ç”Ÿäº§ç¯å¢ƒä¸­PWAå®è·µçš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(8)ä½¿ç”¨Service Workerè¿›è¡Œåå°åŒæ­¥ - Background Sync" href="15288038009038.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(8)ä½¿ç”¨Service Workerè¿›è¡Œåå°åŒæ­¥ - Background Sync</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(7)ä½¿ç”¨Notification APIæ¥è¿›è¡Œæ¶ˆæ¯æé†’" href="15288036503920.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(7)ä½¿ç”¨Notification APIæ¥è¿›è¡Œæ¶ˆæ¯æé†’</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(6) åœ¨Chromeä¸­è°ƒè¯•ä½ çš„PWA" href="15288035758780.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(6) åœ¨Chromeä¸­è°ƒè¯•ä½ çš„PWA</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(5)åœ¨Webä¸­è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€" href="15288030176091.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(5)åœ¨Webä¸­è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(4) è§£å†³FireBase loginéªŒè¯å¤±è´¥é—®é¢˜" href="15235166926023.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(4) è§£å†³FireBase loginéªŒè¯å¤±è´¥é—®é¢˜</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(3) è®©ä½ çš„WebAppç¦»çº¿å¯ç”¨" href="15235151669706.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(3) è®©ä½ çš„WebAppç¦»çº¿å¯ç”¨</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(2) ä½¿ç”¨Manifestï¼Œè®©ä½ çš„WebAppæ›´â€œNativeâ€" href="15235140795593.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(2) ä½¿ç”¨Manifestï¼Œè®©ä½ çš„WebAppæ›´â€œNativeâ€</a></li>
                        
                          <li><a title="ã€PWAå­¦ä¹ ä¸å®è·µã€‘(1) 2018ï¼Œå¼€å§‹ä½ çš„PWAå­¦ä¹ ä¹‹æ—…" href="15235138633619.html">ã€PWAå­¦ä¹ ä¸å®è·µã€‘(1) 2018ï¼Œå¼€å§‹ä½ çš„PWAå­¦ä¹ ä¹‹æ—…</a></li>
                        

                    
                      <li class="side-title"><span>React</span></li>
                        
                          <li><a title="åŸºäºreactæŠ€æœ¯æ ˆçš„å•é¡µåº”ç”¨(SPA)æ­å»º_å¿«é€Ÿå…¥é—¨å®è·µ" href="15236392559880.html">åŸºäºreactæŠ€æœ¯æ ˆçš„å•é¡µåº”ç”¨(SPA)æ­å»º_å¿«é€Ÿå…¥é—¨å®è·µ</a></li>
                        
                          <li><a title="åœ¨react-router4ä¸­è¿›è¡Œä»£ç æ‹†åˆ†ï¼ˆåŸºäºwebpackï¼‰" href="15235187668595.html">åœ¨react-router4ä¸­è¿›è¡Œä»£ç æ‹†åˆ†ï¼ˆåŸºäºwebpackï¼‰</a></li>
                        

                    
                      <li class="side-title"><span>CSS</span></li>
                        
                          <li><a title="ã€CSSæ¨¡å—åŒ–ã€‘(3) ä½¿ç”¨ğŸ’…styled-componentsæ¥ä¼˜åŒ–reactç»„ä»¶å¼€å‘" href="15236398426783.html">ã€CSSæ¨¡å—åŒ–ã€‘(3) ä½¿ç”¨ğŸ’…styled-componentsæ¥ä¼˜åŒ–reactç»„ä»¶å¼€å‘</a></li>
                        
                          <li><a title="ã€CSSæ¨¡å—åŒ–ã€‘(2) BEMå‘½åæ–¹æ³•è®ºâ€”â€”ä½¿ç”¨BEM-constructoræ„å»ºCSS" href="15236396803035.html">ã€CSSæ¨¡å—åŒ–ã€‘(2) BEMå‘½åæ–¹æ³•è®ºâ€”â€”ä½¿ç”¨BEM-constructoræ„å»ºCSS</a></li>
                        
                          <li><a title="ã€CSSæ¨¡å—åŒ–ã€‘(1) webpackä¹‹Local Scope" href="15236395841604.html">ã€CSSæ¨¡å—åŒ–ã€‘(1) webpackä¹‹Local Scope</a></li>
                        

                    
                      <li class="side-title"><span>Server</span></li>
                        
                          <li><a title="ã€MongoDBé«˜å¯ç”¨ã€‘å¤åˆ¶é›†Replica Setä½¿ç”¨ç®€ä»‹" href="15236400113573.html">ã€MongoDBé«˜å¯ç”¨ã€‘å¤åˆ¶é›†Replica Setä½¿ç”¨ç®€ä»‹</a></li>
                        

                    
                      <li class="side-title"><span>Automation</span></li>
                        
                          <li><a title="Gulp.jså®è·µè¯¦è§£__åŸºäºGulpçš„å¤šé¡µé¢åº”ç”¨å®è·µæŒ‡å—" href="15236401468681.html">Gulp.jså®è·µè¯¦è§£__åŸºäºGulpçš„å¤šé¡µé¢åº”ç”¨å®è·µæŒ‡å—</a></li>
                        

                    
                      <li class="side-title"><span>FE else</span></li>
                        
                          <li><a title="å„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹ï¼ˆPolling/COMET/SSE/WebSocketï¼‰" href="15288039493853.html">å„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹ï¼ˆPolling/COMET/SSE/WebSocketï¼‰</a></li>
                        
                          <li><a title="æµè§ˆå™¨åŒæºç­–ç•¥ä¸ajaxè·¨åŸŸæ–¹æ³•æ±‡æ€»" href="15236404711802.html">æµè§ˆå™¨åŒæºç­–ç•¥ä¸ajaxè·¨åŸŸæ–¹æ³•æ±‡æ€»</a></li>
                        
                          <li><a title="JavaScriptå¼‚æ­¥ç¼–ç¨‹__â€œå›è°ƒåœ°ç‹±â€çš„ä¸€äº›è§£å†³æ–¹æ¡ˆ" href="15236403350295.html">JavaScriptå¼‚æ­¥ç¼–ç¨‹__â€œå›è°ƒåœ°ç‹±â€çš„ä¸€äº›è§£å†³æ–¹æ¡ˆ</a></li>
                        
                          <li><a title="jsæ§åˆ¶inputæ¡†å†…å…‰æ ‡ä½ç½®ï¼ˆsetSelectionRangeè¯¦è§£ï¼‰" href="15236405992551.html">jsæ§åˆ¶inputæ¡†å†…å…‰æ ‡ä½ç½®ï¼ˆsetSelectionRangeè¯¦è§£ï¼‰</a></li>
                        

                    
                      <li class="side-title"><span>Reading</span></li>
                        
                          <li><a title="æ¨èé˜…è¯» 2018.06" href="15288017709756.html">æ¨èé˜…è¯» 2018.06</a></li>
                        
                          <li><a title="æ¨èé˜…è¯» 2018.05" href="15287963471356.html">æ¨èé˜…è¯» 2018.05</a></li>
                        
                          <li><a title="æ¨èé˜…è¯» 2018.04" href="15283399559020.html">æ¨èé˜…è¯» 2018.04</a></li>
                        
                          <li><a title="æ¨èé˜…è¯» 2018.03" href="15282529256902.html">æ¨èé˜…è¯» 2018.03</a></li>
                        

                    
                      <li class="side-title"><span>Performace</span></li>
                        
                          <li><a title="ã€æ€§èƒ½ä¼˜åŒ–å®è·µã€‘ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦" href="15288037747207.html">ã€æ€§èƒ½ä¼˜åŒ–å®è·µã€‘ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>ã€PWAå­¦ä¹ ä¸å®è·µã€‘(8)ä½¿ç”¨Service Workerè¿›è¡Œåå°åŒæ­¥ - Background Sync</h1>

<p>æœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬å…«ç¯‡æ–‡ç« ã€‚</p>

<p>PWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚</p>

<p>æœ¬ç³»åˆ—æ–‡ç« ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ä¼šé€æ­¥æ‹†è§£PWAèƒŒåçš„å„é¡¹æŠ€æœ¯ï¼Œé€šè¿‡å®ä¾‹ä»£ç æ¥è®²è§£è¿™äº›æŠ€æœ¯çš„åº”ç”¨æ–¹å¼ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºPWAä¸­æŠ€æœ¯ç‚¹ä¼—å¤šã€çŸ¥è¯†ç»†ç¢ï¼Œå› æ­¤æˆ‘åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œè¿›è¡Œäº†æ•´ç†ï¼Œå¹¶äº§å‡ºäº†ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ï¼Œå¸Œæœ›èƒ½å¸¦å¤§å®¶å…¨é¢äº†è§£PWAä¸­çš„å„é¡¹æŠ€æœ¯ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€‚</p>

<blockquote>
<p>æœ¬æ–‡ä¸­çš„ä»£ç å¯ä»¥åœ¨<a href="https://github.com/alienzhou/learning-pwa/tree/sync">learning-pwaçš„syncåˆ†æ”¯</a>ä¸Šæ‰¾åˆ°ï¼ˆ<code>git clone</code>åæ³¨æ„åˆ‡æ¢åˆ°syncåˆ†æ”¯ï¼‰ã€‚</p>
</blockquote>

<h2 id="toc_0">1. å¼•è¨€</h2>

<p>ç”Ÿæ´»ä¸­ç»å¸¸ä¼šæœ‰è¿™æ ·çš„åœºæ™¯ï¼š</p>

<p>ç”¨æˆ·æ‹¿å‡ºæ‰‹æœºï¼Œæµè§ˆç€æˆ‘ä»¬çš„ç½‘ç«™ï¼Œå‘ç°äº†ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ä¿¡æ¯ï¼Œç‚¹å‡»äº†â€œæäº¤â€æŒ‰é’®ã€‚ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œè¿™æ—¶ç”¨æˆ·åˆ°äº†ä¸€ä¸ªç½‘ç»œç¯å¢ƒæå·®çš„åœ°æ–¹ï¼Œæˆ–è€…æ˜¯æ ¹æœ¬æ²¡æœ‰ç½‘ç»œã€‚ä»–èƒ½å¤Ÿåšçš„åªæœ‰çœ‹ç€é¡µé¢ä¸Šçš„æç¤ºæ¡†å’Œä¸æ–­æ—‹è½¬çš„ç­‰å¾…å°åœ†åœˆã€‚1sã€5sã€30sã€1minâ€¦â€¦æ— å°½çš„ç­‰å¾…åï¼Œç”¨æˆ·å°†æ‰‹æœºæ”¾å›äº†å£è¢‹ï¼Œè€Œè¿™ä¸€æ¬¡çš„è¯·æ±‚ä¹Ÿè¢«ç»ˆæ­¢äº†â€”â€”ç”±äºå½“ä¸‹æå·®çš„ç½‘ç»œç»ˆæ­¢åœ¨äº†å®¢æˆ·ç«¯ã€‚</p>

<p>ä¸Šé¢çš„åœºæ™¯å…¶å®æš´éœ²äº†ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<ol>
<li>æ™®é€šçš„é¡µé¢å‘èµ·çš„è¯·æ±‚ä¼šéšç€æµè§ˆå™¨è¿›ç¨‹çš„ç»“æŸ/æˆ–è€…Tabé¡µé¢çš„å…³é—­è€Œç»ˆæ­¢ï¼›</li>
<li>æ— ç½‘ç¯å¢ƒä¸‹ï¼Œæ²¡æœ‰ä¸€ç§æœºåˆ¶èƒ½â€œç»´æŒâ€ä½è¯¥è¯·æ±‚ï¼Œä»¥å¾…æœ‰ç½‘æƒ…å†µä¸‹å†è¿›è¡Œè¯·æ±‚ã€‚</li>
</ol>

<p>ç„¶è€Œï¼ŒService Workerçš„åå°åŒæ­¥åŠŸèƒ½è§„é¿äº†è¿™äº›ç¼ºé™·ã€‚</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/163598ca174364ed?w=800&amp;h=499&amp;f=gif&amp;s=2269837" alt=""/></p>

<p>ä¸‹é¢å°±è®©æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹åå°åŒæ­¥ï¼ˆBackground Syncï¼‰çš„å·¥ä½œåŸç†ã€‚</p>

<h2 id="toc_1">2. åå°åŒæ­¥(Background Sync)æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h2>

<p>åå°åŒæ­¥åº”è¯¥ç®—æ˜¯Service Workerç›¸å…³åŠŸèƒ½ï¼ˆAPIï¼‰ä¸­æ¯”è¾ƒæ˜“äºç†è§£ä¸ä½¿ç”¨çš„ä¸€ä¸ªã€‚</p>

<p>å…¶å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/1635905056b125a7?w=573&amp;h=129&amp;f=png&amp;s=8623" alt=""/></p>

<ol>
<li>é¦–å…ˆï¼Œä½ éœ€è¦åœ¨Service Workerä¸­ç›‘å¬syncäº‹ä»¶ï¼›</li>
<li>ç„¶åï¼Œåœ¨æµè§ˆå™¨ä¸­å‘èµ·åå°åŒæ­¥syncï¼ˆå›¾ä¸­ç¬¬ä¸€æ­¥ï¼‰ï¼›</li>
<li>ä¹‹åï¼Œä¼šè§¦å‘Service Workerçš„syncäº‹ä»¶ï¼Œåœ¨è¯¥ç›‘å¬çš„å›è°ƒä¸­è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚å‘åç«¯å‘èµ·è¯·æ±‚ï¼ˆå›¾ä¸­ç¬¬äºŒæ­¥ï¼‰</li>
<li>æœ€åï¼Œå¯ä»¥åœ¨Service Workerä¸­å¯¹æœåŠ¡ç«¯è¿”å›çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚</li>
</ol>

<p>ç”±äºService Workeråœ¨ç”¨æˆ·å…³é—­è¯¥ç½‘ç«™åä»å¯ä»¥è¿è¡Œï¼Œå› æ­¤è¯¥æµç¨‹åä¸ºâ€œåå°åŒæ­¥â€å®åœ¨æ˜¯éå¸¸è´´åˆ‡ã€‚</p>

<p>æ€ä¹ˆæ ·ï¼Œåœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€å®šçš„Service WorkeråŸºç¡€ä¹‹åï¼Œåå°åŒæ­¥è¿™ä¸€åŠŸèƒ½ç›¸æ¯”ä¹‹å‰çš„åŠŸèƒ½ï¼Œæ˜¯ä¸æ˜¯éå¸¸æ˜“äºç†è§£ï¼Ÿ</p>

<h2 id="toc_2">3. å¦‚ä½•ä½¿ç”¨åå°åŒæ­¥åŠŸèƒ½ï¼Ÿ</h2>

<p>æ—¢ç„¶å·²ç»ç†è§£äº†è¯¥åŠŸèƒ½çš„å¤§è‡´æµç¨‹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ¥å®é™…æ“ä½œä¸€ä¸‹å§ã€‚</p>

<h3 id="toc_3">3.1 clientè§¦å‘syncäº‹ä»¶</h3>

<pre><code class="language-javascript">// index.js
navigator.serviceWorker.ready.then(function (registration) {
    var tag = &quot;sample_sync&quot;;
    document.getElementById(&#39;js-sync-btn&#39;).addEventListener(&#39;click&#39;, function () {
        registration.sync.register(tag).then(function () {
            console.log(&#39;åå°åŒæ­¥å·²è§¦å‘&#39;, tag);
        }).catch(function (err) {
            console.log(&#39;åå°åŒæ­¥è§¦å‘å¤±è´¥&#39;, err);
        });
    });
});
</code></pre>

<p>ç”±äºåå°åŒæ­¥åŠŸèƒ½éœ€è¦åœ¨Service Workeræ³¨å†Œå®Œæˆåè§¦å‘ï¼Œå› æ­¤è¾ƒå¥½çš„ä¸€ä¸ªæ–¹å¼æ˜¯åœ¨<code>navigator.serviceWorker.ready</code>ä¹‹åç»‘å®šç›¸å…³æ“ä½œã€‚ä¾‹å¦‚ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨readyåç»‘å®šäº†æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ã€‚å½“æŒ‰é’®è¢«ç‚¹å‡»åï¼Œä¼šä½¿ç”¨<code>registration.sync.register()</code>æ–¹æ³•æ¥è§¦å‘Service Workerçš„syncäº‹ä»¶ã€‚</p>

<p><code>registration.sync</code>è¿”å›ä¸€ä¸ª<a href="https://developer.mozilla.org/en-US/docs/Web/API/SyncManager"><code>SyncManager</code>å¯¹è±¡</a>ï¼Œå…¶ä¸ŠåŒ…å«<code>register</code>å’Œ<code>getTags</code>ä¸¤ä¸ªæ–¹æ³•ï¼š</p>

<blockquote>
<p><code>register()</code> Create a new sync registration and return a Promise. </p>

<p><code>getTags()</code> Return a list of developer-defined identifiers for SyncManager registration.</p>
</blockquote>

<p><code>register()</code>æ–¹æ³•å¯ä»¥æ³¨å†Œä¸€ä¸ªåå°åŒæ­¥äº‹ä»¶ï¼Œå…¶ä¸­æ¥æ”¶çš„å‚æ•°<code>tag</code>ç”¨äºä½œä¸ºè¿™ä¸ªåå°åŒæ­¥çš„å”¯ä¸€æ ‡è¯†ã€‚</p>

<p>å½“ç„¶ï¼Œå¦‚æœæƒ³è¦ä»£ç æ›´å¥å£®çš„è¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨è°ƒç”¨å‰è¿›è¡Œç‰¹æ€§æ£€æµ‹ï¼š</p>

<pre><code class="language-javascript">// index.js
if (&#39;serviceWorker&#39; in navigator &amp;&amp; &#39;SyncManager&#39; in window) {
    // â€¦â€¦
}
</code></pre>

<h3 id="toc_4">3.2 åœ¨Service Workerä¸­ç›‘å¬syncäº‹ä»¶</h3>

<p>å½“clientè§¦å‘äº†syncäº‹ä»¶åï¼Œå‰©ä¸‹çš„å°±äº¤ç»™Service Workerã€‚ç†è®ºä¸Šæ­¤æ—¶å°±ä¸éœ€è¦clientï¼ˆå‰ç«¯ç«™ç‚¹ï¼‰å‚ä¸äº†ã€‚ä¾‹å¦‚å¦ä¸€ä¸ªç»å…¸åœºæ™¯ï¼šç”¨æˆ·ç¦»å¼€æ—¶é¡µé¢ï¼ˆunloadï¼‰æ—¶åœ¨clientç«¯è§¦å‘syncäº‹ä»¶ï¼Œå‰©ä¸‹çš„æ“ä½œäº¤ç»™Service Workerï¼ŒService Workerçš„æ“ä½œå¯ä»¥åœ¨ç¦»å¼€é¡µé¢åæ­£å¸¸è¿›è¡Œã€‚</p>

<p>åƒæ·»åŠ fetchå’Œpushäº‹ä»¶ç›‘å¬é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºService Workeræ·»åŠ syncäº‹ä»¶çš„ç›‘å¬ï¼š</p>

<pre><code class="language-javascript">// sw.js
self.addEventListener(&#39;sync&#39;, function (e) {
    // â€¦â€¦
});
</code></pre>

<p>åœ¨syncäº‹ä»¶çš„eventå¯¹è±¡ä¸Šå¯ä»¥å–åˆ°tagå€¼ï¼Œè¯¥å€¼å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚æ³¨å†Œsyncæ—¶çš„å”¯ä¸€æ ‡è¯†ã€‚é€šè¿‡è¿™ä¸ªtagå°±å¯ä»¥åŒºåˆ†å‡ºä¸åŒçš„åå°åŒæ­¥äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå½“è¯¥å€¼ä¸º&#39;sample_sync&#39;æ—¶æˆ‘ä»¬å‘åç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼š</p>

<pre><code class="language-javascript">// sw.js
self.addEventListener(&#39;sync&#39;, function (e) {
    console.log(`service workeréœ€è¦è¿›è¡Œåå°åŒæ­¥ï¼Œtag: ${e.tag}`);
    var init = {
        method: &#39;GET&#39;
    };
    if (e.tag === &#39;sample_sync&#39;) {
        var request = new Request(`sync?name=AlienZHOU`, init);
        e.waitUntil(
            fetch(request).then(function (response) {
                response.json().then(console.log.bind(console));
                return response;
            })
        );
    }
});
</code></pre>

<p>è¿™é‡Œæˆ‘é€šè¿‡<code>e.tag</code>æ¥åˆ¤æ–­clientè§¦å‘çš„ä¸åŒsyncäº‹ä»¶ï¼Œå¹¶åœ¨ç›‘å¬åˆ°tagä¸º&#39;sample_sync&#39;çš„syncäº‹ä»¶åï¼Œæ„å»ºäº†ä¸€ä¸ªrequestå¯¹è±¡ï¼Œä½¿ç”¨fetch APIæ¥è¿›è¡Œåç«¯è¯·æ±‚ã€‚</p>

<p>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œfetchè¯·æ±‚ä¸€å®šè¦æ”¾åœ¨<code>e.waitUntil()</code>å†…ã€‚å› ä¸ºæˆ‘ä»¬è¦ä¿è¯â€œåå°åŒæ­¥â€ï¼Œå°†Promiseå¯¹è±¡æ”¾åœ¨<code>e.waitUntil()</code>å†…å¯ä»¥ç¡®ä¿åœ¨ç”¨æˆ·ç¦»å¼€æˆ‘ä»¬çš„ç½‘ç«™åï¼ŒService Workerä¼šæŒç»­åœ¨åå°è¿è¡Œï¼Œç­‰å¾…è¯¥è¯·æ±‚å®Œæˆã€‚</p>

<h3 id="toc_5">3.3 å®Œå–„æˆ‘ä»¬çš„åç«¯æœåŠ¡</h3>

<p>å®é™…ä¸Šï¼Œç»è¿‡ä¸Šé¢ä¸¤å°èŠ‚ï¼Œæˆ‘ä»¬çš„å¤§è‡´å·¥ä½œå·²ç»å®Œæˆã€‚ä¸è¿‡è¿˜ç¼ºå°‘ä¸€ä¸ªå°ç¯èŠ‚ï¼šæˆ‘ä»¬çš„KOAæœåŠ¡å™¨ä¸Šè¿˜æ²¡æœ‰syncè·¯ç”±å’Œæ¥å£ã€‚æ·»åŠ ä¸€ä¸‹ï¼Œä»¥ä¿è¯demoå¯ä»¥æ­£å¸¸è¿è¡Œï¼š</p>

<pre><code class="language-javascript">// app.js
router.get(&#39;/sync&#39;, async (ctx, next) =&gt; {
    console.log(`Hello ${ctx.request.query.name}, I have received your msg`);
    ctx.response.body = {
        status: 0
    };
});
</code></pre>

<h3 id="toc_6">3.4 Demoæ•ˆæœå±•ç¤º</h3>

<p>ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªdemoçš„è¿è¡Œæ•ˆæœï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/1635975104e68836?w=800&amp;h=499&amp;f=gif&amp;s=1947627" alt=""/></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç½‘ç»œç¯å¢ƒæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œç‚¹å‡»â€œåŒæ­¥â€æŒ‰é’®ä¼šç«‹å³è§¦å‘Service Workerä¸­çš„syncäº‹ä»¶ç›‘å¬ï¼Œå¹¶å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼›è€Œåœ¨æ–­ç½‘æƒ…å†µä¸‹ï¼Œç‚¹å‡»â€œåŒæ­¥â€æŒ‰é’®ï¼Œæ§åˆ¶å°è™½ç„¶æ˜¾ç¤ºæ³¨å†Œäº†åŒæ­¥äº‹ä»¶ï¼Œä½†æ˜¯å¹¶ä¸ä¼šè§¦å‘Service Workerçš„syncç›‘å¬å›è°ƒï¼ŒæŒ‡åˆ°æ¢å¤ç½‘ç»œè¿æ¥ï¼Œæ‰ä¼šåœ¨åå°ï¼ˆService Workerï¼‰ä¸­è¿›è¡Œç›¸å…³å¤„ç†ã€‚</p>

<p>ä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹è§¦å‘syncäº‹ä»¶åï¼Œå…³é—­ç½‘ç«™çš„æ•ˆæœï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/163598ca174364ed?w=800&amp;h=499&amp;f=gif&amp;s=2269837" alt=""/></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿åœ¨å…³é—­ç½‘ç«™åå†é‡æ–°è¿æ¥ç½‘ç»œï¼ŒæœåŠ¡ç«¯ä¾ç„¶å¯ä»¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ˆè¯´æ˜Service Workeråœ¨åå°è¿›è¡Œäº†ç›¸å…³å¤„ç†ï¼‰ã€‚</p>

<h2 id="toc_7">4. å¦‚ä½•åœ¨åå°åŒæ­¥æ—¶è·å–æ‰€éœ€çš„æ•°æ®ï¼Ÿ</h2>

<p>å…¶å®ä¸Šä¸€èŠ‚ç»“æŸï¼Œæˆ‘ä»¬å°±å·²ç»å¯ä»¥äº†è§£æœ€åŸºç¡€çš„åå°åŒæ­¥åŠŸèƒ½äº†ã€‚è€Œè¿™éƒ¨åˆ†åˆ™ä¼šè¿›ä¸€æ­¥æ¢è®¨åå°åŒæ­¥ä¸­çš„ä¸€ä¸ªé‡è¦é—®é¢˜ï¼šå¦‚ä½•åœ¨åå°åŒæ­¥æ—¶è·å–å¹¶å‘é€clientä¸­çš„æ•°æ®ï¼Ÿ</p>

<p>ä¾‹å¦‚åœ¨æˆ‘ä»¬çš„ä¸Šä¸€ä¸ªDemoä¸­ï¼Œç”¨æˆ·çš„å§“ånameæ˜¯ç¡¬ç¼–ç åœ¨Service Workerä¸­çš„ï¼Œè€Œå®é™…ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½åœ¨é¡µé¢ä¸Šæä¾›ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œå°†ç”¨æˆ·çš„è¾“å…¥å†…å®¹åœ¨åå°åŒæ­¥ä¸­è¿›è¡Œå‘é€ã€‚</p>

<p>å®ç°çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šä½¿ç”¨postMessageæˆ–ä½¿ç”¨indexedDBã€‚</p>

<h3 id="toc_8">4.1 ä½¿ç”¨postMessage</h3>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æµè§ˆå™¨ä¸»çº¿ç¨‹ä¸Web Workerçº¿ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡postMessageæ¥è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥å‘Service Workerâ€œä¼ è¾“â€æ•°æ®ã€‚</p>

<p>å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š</p>

<ol>
<li>clientè§¦å‘syncäº‹ä»¶ï¼›</li>
<li>åœ¨syncæ³¨å†Œå®Œæˆåï¼Œä½¿ç”¨postMessageå’ŒService Workeré€šä¿¡ï¼›</li>
<li>åœ¨Service Workerçš„syncäº‹ä»¶å›è°ƒä¸­ç­‰å¾…messageäº‹ä»¶çš„æ¶ˆæ¯ï¼›</li>
<li>æ”¶åˆ°messageäº‹ä»¶çš„æ¶ˆæ¯åï¼Œå°†å…¶ä¸­çš„ä¿¡æ¯æäº¤åˆ°æœåŠ¡ç«¯ã€‚</li>
</ol>

<pre><code class="language-javascript">// index.js
// ä½¿ç”¨postMessageæ¥ä¼ è¾“syncæ•°æ®
navigator.serviceWorker.ready.then(function (registration) {
    var tag = &#39;sample_sync_event&#39;;

    document.getElementById(&#39;js-sync-event-btn&#39;).addEventListener(&#39;click&#39;, function () {
        registration.sync.register(tag).then(function () {
            console.log(&#39;åå°åŒæ­¥å·²è§¦å‘&#39;, tag);

            // ä½¿ç”¨postMessageè¿›è¡Œæ•°æ®é€šä¿¡
            var inputValue = document.querySelector(&#39;#js-search-input&#39;).value;
            var msg = JSON.stringify({type: &#39;bgsync&#39;, msg: {name: inputValue}});
            navigator.serviceWorker.controller.postMessage(msg);
        }).catch(function (err) {
            console.log(&#39;åå°åŒæ­¥è§¦å‘å¤±è´¥&#39;, err);
        });
    });
});
</code></pre>

<p>åœ¨<code>registration.sync.register</code>å®Œæˆåï¼Œè°ƒç”¨<code>navigator.serviceWorker.controller.postMessage</code>æ¥å‘Service Worker Postæ•°æ®ã€‚</p>

<p>ä¸ºäº†æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œæˆ‘åœ¨sw.jsä¸­åˆ›å»ºäº†ä¸€ä¸ª<code>SimpleEvent</code>ç±»ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªæœ€ç®€å•çš„EventBusã€‚ç”¨æ¥è§£è€¦Service Workerçš„messageäº‹ä»¶å’Œsyncäº‹ä»¶ã€‚</p>

<pre><code class="language-javascript">// sw.js
class SimpleEvent {
    constructor() {
        this.listenrs = {};
    }

    once(tag, cb) {
        this.listenrs[tag] || (this.listenrs[tag] = []);
        this.listenrs[tag].push(cb);
    }

    trigger(tag, data) {
        this.listenrs[tag] = this.listenrs[tag] || [];
        let listenr;
        while (listenr = this.listenrs[tag].shift()) {
            listenr(data)
        }
    }
}
</code></pre>

<p>åœ¨messageäº‹ä»¶ä¸­ç›‘å¬clientå‘æ¥çš„æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡SimpleEventé€šçŸ¥æ‰€æœ‰ç›‘å¬è€…ã€‚</p>

<pre><code class="language-javascript">// sw.js
const simpleEvent = new SimpleEvent();
self.addEventListener(&#39;message&#39;, function (e) {
    var data = JSON.parse(e.data);
    var type = data.type;
    var msg = data.msg;
    console.log(`service workeræ”¶åˆ°æ¶ˆæ¯ typeï¼š${type}ï¼›msgï¼š${JSON.stringify(msg)}`);

    simpleEvent.trigger(type, msg);
});
</code></pre>

<p>åœ¨syncäº‹ä»¶ä¸­ï¼Œä½¿ç”¨SimpleEventç›‘å¬bgsyncæ¥è·å–æ•°æ®ï¼Œç„¶åå†è°ƒç”¨fetchæ–¹æ³•ã€‚æ³¨æ„ï¼Œç”±äº<code>e.waitUntil()</code>éœ€è¦æ¥æ”¶Promiseä½œä¸ºå‚æ•°ï¼Œå› æ­¤éœ€è¦å¯¹<code>SimpleEvent.once</code>è¿›è¡ŒPromisfyã€‚</p>

<pre><code class="language-javascript">// sw.js
self.addEventListener(&#39;sync&#39;, function (e) {
    if (e.tag === xxx) {
        // â€¦â€¦
    }

    // sample_sync_eventåŒæ­¥äº‹ä»¶ï¼Œä½¿ç”¨postMessageæ¥è¿›è¡Œæ•°æ®é€šä¿¡
    else if (e.tag === &#39;sample_sync_event&#39;) {
        // å°†SimpleEvent.onceå°è£…ä¸ºPromiseè°ƒç”¨
        let msgPromise = new Promise(function (resolve, reject) {
            // ç›‘å¬messageäº‹ä»¶ä¸­è§¦å‘çš„äº‹ä»¶é€šçŸ¥
            simpleEvent.once(&#39;bgsync&#39;, function (data) {
                resolve(data);
            });
            // äº”ç§’è¶…æ—¶
            setTimeout(resolve, 5000);
        });

        e.waitUntil(
            msgPromise.then(function (data) {
                var name = data &amp;&amp; data.name ? data.name : &#39;anonymous&#39;;
                var request = new Request(`sync?name=${name}`, init);
                return fetch(request)
            }).then(function (response) {
                response.json().then(console.log.bind(console));
                return response;
            })
        );
    }
});
</code></pre>

<p>æ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼Ÿ</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/14/1635a5723bed476c?w=800&amp;h=499&amp;f=gif&amp;s=2772919" alt=""/></p>

<p>è¿›è¡Œåå°åŒæ­¥æ—¶ï¼Œä½¿ç”¨postMessageæ¥å®ç°clientå‘Service Workerçš„ä¼ è¾“æ•°æ®ï¼Œæ–¹ä¾¿ä¸ç›´è§‚ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„æ–¹æ³•ã€‚</p>

<h3 id="toc_9">4.2 ä½¿ç”¨indexedDB</h3>

<p>åœ¨clientä¸Servcie Workerä¹‹é—´åŒæ­¥æ•°æ®ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯è¡Œçš„æ€è·¯ï¼šclientå…ˆå°†æ•°æ®å­˜åœ¨æŸå¤„ï¼Œå¾…Servcie Workeréœ€è¦æ—¶å†è¯»å–ä½¿ç”¨å³å¯ã€‚</p>

<p>ä¸ºæ­¤éœ€è¦æ‰¾ä¸€ä¸ªå­˜æ•°æ®çš„åœ°æ–¹ã€‚ä½ ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å¯èƒ½å°±æ˜¯localStorageäº†ã€‚</p>

<p>ç„¶è€Œï¼Œä¸çŸ¥é“ä½ æ˜¯å¦è¿˜è®°å¾—æˆ‘åœ¨æœ€å¼€å§‹ä»‹ç»Service Workeræ—¶æ‰€æåˆ°çš„ï¼Œä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œå®ç°éƒ¨åˆ†æ“ä½œçš„éé˜»å¡ï¼Œåœ¨Service Workerä¸­æˆ‘ä»¬ç»å¸¸ä¼šç¢°åˆ°å¼‚æ­¥æ“ä½œï¼ˆå› æ­¤å¤§å¤šæ•°APIéƒ½æ˜¯Promiseå½¢å¼çš„ï¼‰ã€‚é‚£ä¹ˆåƒlocalStorageè¿™æ ·çš„åŒæ­¥APIä¼šå˜æˆå¼‚æ­¥åŒ–ä¹ˆï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼šä¸ä¼šï¼Œå¹¶ä¸”localStorageåœ¨Servcie Workerä¸­æ— æ³•è°ƒç”¨ã€‚</p>

<p>ä¸è¿‡ä¸è¦æ°”é¦ï¼Œæˆ‘ä»¬è¿˜å¦ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®å­˜å‚¨æ–¹å¼â€”â€”indexedDBã€‚å®ƒæ˜¯å¯ä»¥åœ¨Service Workerä¸­ä½¿ç”¨çš„ã€‚å¯¹äºindexedDBçš„ä½¿ç”¨æ–¹å¼ï¼Œæœ¬ç³»åˆ—åç»­ä¼šæœ‰æ–‡ç« å…·ä½“ä»‹ç»ï¼Œå› æ­¤åœ¨è¿™é‡Œçš„å°±ä¸é‡ç‚¹è®²è§£indexedDBçš„ä½¿ç”¨æ–¹å¼äº†ã€‚</p>

<p>é¦–å…ˆï¼Œéœ€è¦ä¸€ä¸ªæ–¹æ³•ç”¨äºè¿æ¥æ•°æ®åº“å¹¶åˆ›å»ºç›¸åº”çš„storeï¼š</p>

<pre><code class="language-javascript">// index.js
function openStore(storeName) {
    return new Promise(function (resolve, reject) {
        if (!(&#39;indexedDB&#39; in window)) {
            reject(&#39;don\&#39;t support indexedDB&#39;);
        }
        var request = indexedDB.open(&#39;PWA_DB&#39;, 1);
        request.onerror = function(e) {
            console.log(&#39;è¿æ¥æ•°æ®åº“å¤±è´¥&#39;);
            reject(e);
        }
        request.onsuccess = function(e) {
            console.log(&#39;è¿æ¥æ•°æ®åº“æˆåŠŸ&#39;);
            resolve(e.target.result);
        }
        request.onupgradeneeded = function (e) {
            console.log(&#39;æ•°æ®åº“ç‰ˆæœ¬å‡çº§&#39;);
            var db = e.srcElement.result;
            if (e.oldVersion === 0) {
                if (!db.objectStoreNames.contains(storeName)) {
                    var store = db.createObjectStore(storeName, {
                        keyPath: &#39;tag&#39;
                    });
                    store.createIndex(storeName + &#39;Index&#39;, &#39;tag&#39;, {unique: false});
                    console.log(&#39;åˆ›å»ºç´¢å¼•æˆåŠŸ&#39;);
                }
            }
        }
    });
}
</code></pre>

<p>ç„¶åï¼Œåœ¨<code>navigator.serviceWorker.ready</code>ä¸­æ‰“å¼€è¯¥æ•°æ®åº“è¿æ¥ï¼Œå¹¶åœ¨ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œå…ˆå°†æ•°æ®å­˜å…¥indexedDBï¼Œå†æ³¨å†Œsyncï¼š</p>

<pre><code class="language-javascript">// index.js
navigator.serviceWorker.ready.then(function (registration) {
    return Promise.all([
        openStore(STORE_NAME),
        registration
    ]);
}).then(function (result) {
    var db = result[0];
    var registration = result[1];
    var tag = &#39;sample_sync_db&#39;;

    document.getElementById(&#39;js-sync-db-btn&#39;).addEventListener(&#39;click&#39;, function () {
        // å°†æ•°æ®å­˜å‚¨è¿›indexedDB
        var inputValue = document.querySelector(&#39;#js-search-input&#39;).value;
        var tx = db.transaction(STORE_NAME, &#39;readwrite&#39;);
        var store = tx.objectStore(STORE_NAME);
        var item = {
            tag: tag,
            name: inputValue
        };
        store.put(item);

        registration.sync.register(tag).then(function () {
            console.log(&#39;åå°åŒæ­¥å·²è§¦å‘&#39;, tag);
        }).catch(function (err) {
            console.log(&#39;åå°åŒæ­¥è§¦å‘å¤±è´¥&#39;, err);
        });
    });
});
</code></pre>

<p>åŒæ ·çš„ï¼Œåœ¨Service Workerä¸­ä¹Ÿéœ€è¦ç›¸åº”çš„æ•°æ®åº“è¿æ¥æ–¹æ³•ï¼š</p>

<pre><code class="language-javascript">// sw.js
function openStore(storeName) {
    return new Promise(function (resolve, reject) {
        var request = indexedDB.open(&#39;PWA_DB&#39;, 1);
        request.onerror = function(e) {
            console.log(&#39;è¿æ¥æ•°æ®åº“å¤±è´¥&#39;);
            reject(e);
        }
        request.onsuccess = function(e) {
            console.log(&#39;è¿æ¥æ•°æ®åº“æˆåŠŸ&#39;);
            resolve(e.target.result);
        }
    });
}
</code></pre>

<p>å¹¶ä¸”åœ¨syncäº‹ä»¶çš„å›è°ƒä¸­ï¼Œgetåˆ°indexedDBä¸­å¯¹åº”çš„æ•°æ®ï¼Œæœ€åå†å‘åç«¯å‘é€è¯·æ±‚ï¼š</p>

<pre><code class="language-javascript">// index.js
self.addEventListener(&#39;sync&#39;, function (e) {
    if (e.tag === xxx) {
        // â€¦â€¦
    }
    else if (e.tag === yyy) {
        // â€¦â€¦
    }
    
    // sample_sync_dbåŒæ­¥äº‹ä»¶ï¼Œä½¿ç”¨indexedDBæ¥è·å–éœ€è¦åŒæ­¥çš„æ•°æ®
    else if (e.tag === &#39;sample_sync_db&#39;) {
        // å°†æ•°æ®åº“æŸ¥è¯¢å°è£…ä¸ºPromiseç±»å‹çš„è¯·æ±‚
        var dbQueryPromise = new Promise(function (resolve, reject) {
            var STORE_NAME = &#39;SyncData&#39;;
            // è¿æ¥indexedDB
            openStore(e.tag).then(function (db) {
                try {
                    // åˆ›å»ºäº‹åŠ¡è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢
                    var tx = db.transaction(STORE_NAME, &#39;readonly&#39;);
                    var store = tx.objectStore(STORE_NAME);
                    var dbRequest = store.get(e.tag);
                    dbRequest.onsuccess = function (e) {
                        resolve(e.target.result);
                    };
                    dbRequest.onerror = function (err) {
                        reject(err);
                    };
                }
                catch (err) {
                    reject(err);
                }
            });
        });

        e.waitUntil(
            // é€šè¿‡æ•°æ®åº“æŸ¥è¯¢è·å–éœ€è¦åŒæ­¥çš„æ•°æ®
            dbQueryPromise.then(function (data) {
                console.log(data);
                var name = data &amp;&amp; data.name ? data.name : &#39;anonymous&#39;;
                var request = new Request(`sync?name=${name}`, init);
                return fetch(request)
            }).then(function (response) {
                response.json().then(console.log.bind(console));
                return response;
            })
        );
    }
});
</code></pre>

<p>ç›¸æ¯”äºpostMessageï¼Œä½¿ç”¨indexedDBçš„æ–¹æ¡ˆè¦æ›´å¤æ‚ä¸€ç‚¹ã€‚å®ƒæ¯”è¾ƒé€‚ç”¨äºä¸€äº›éœ€è¦æ•°æ®æŒä¹…åŒ–çš„åœºæ™¯ã€‚</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/14/1635a579ba845ce7?w=800&amp;h=499&amp;f=gif&amp;s=953776" alt=""/></p>

<h2 id="toc_10">5. å…¼å®¹æ€§</h2>

<p>ä¾ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥ç®€å•çœ‹ä¸€ä¸‹æ–‡ä¸­ç›¸å…³åŠŸèƒ½çš„å…¼å®¹æ€§ã€‚</p>

<p>å…ˆæ˜¯<a href="https://caniuse.com/#search=Background%20Sync%20API">Background Sync</a>ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/16359f504955c8b8?w=1240&amp;h=592&amp;f=png&amp;s=134469" alt=""/></p>

<p>ä»¤äººæ‚²ä¼¤çš„æ˜¯ï¼ŒåŸºæœ¬åªæœ‰Googleè‡ªå®¶çš„Chromeå¯ç”¨ã€‚</p>

<p>ç„¶åæ˜¯<a href="https://caniuse.com/#search=indexedDB">indexedDB</a>ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/13/16359f671e79ba6b?w=1240&amp;h=580&amp;f=png&amp;s=155435" alt=""/></p>

<p>ç›¸è¾ƒäºBackground Syncè¿˜æ˜¯æœ‰ç€ä¸é”™çš„å…¼å®¹æ€§çš„ã€‚è€Œä¸”åœ¨safariï¼ˆåŒ…æ‹¬iOS safariï¼‰ä¸­ä¹Ÿå¾—åˆ°äº†æ”¯æŒã€‚</p>

<h2 id="toc_11">6. å†™åœ¨æœ€å</h2>

<p>ä»æ–‡ä¸­çš„å†…å®¹ä»¥åŠ<a href="https://developers.google.com/web/updates/2015/12/background-sync#the_solution">google developerä¸­çš„ä¸€äº›å®ä¾‹</a>æ¥çœ‹ï¼ŒBackground Syncæ˜¯ä¸€ä¸ªéå¸¸æœ‰æ½œåŠ›çš„APIã€‚ç„¶è€Œä»¤äººå ªå¿§çš„å…¼å®¹æ€§åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™åˆ¶äº†å®ƒçš„å‘æŒ¥ç©ºé—´ã€‚ä¸è¿‡ï¼Œä½œä¸ºä¸€é¡¹æŠ€æœ¯ï¼Œè¿˜æ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ä¸äº†è§£çš„ã€‚</p>

<p>æœ¬æ–‡ä¸­æ‰€æœ‰çš„ä»£ç ç¤ºä¾‹å‡å¯ä»¥åœ¨<a href="https://github.com/alienzhou/learning-pwa/tree/sync">learn-pwa/sync</a>ä¸Šæ‰¾åˆ°ã€‚</p>

<p>å¦‚æœä½ å–œæ¬¢æˆ–æƒ³è¦äº†è§£æ›´å¤šçš„PWAç›¸å…³çŸ¥è¯†ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ï¼Œå…³æ³¨<a href="https://juejin.im/user/59ad5377518825244d206d2d/posts">ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹</a>ç³»åˆ—æ–‡ç« ã€‚æˆ‘ä¼šæ€»ç»“æ•´ç†è‡ªå·±å­¦ä¹ PWAè¿‡ç¨‹çš„é‡åˆ°çš„ç–‘é—®ä¸æŠ€æœ¯ç‚¹ï¼Œå¹¶é€šè¿‡å®é™…ä»£ç å’Œå¤§å®¶ä¸€èµ·å®è·µã€‚</p>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†PWAä¸­çš„å¤šä¸ªçŸ¥è¯†ç‚¹ï¼Œåœ¨å…¶åŸºç¡€ä¸Šï¼Œå·²ç»å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡ŒåŸæœ‰ç«™ç‚¹çš„PWAå‡çº§ã€‚å­¦ä¹ æ˜¯ä¸€æ–¹é¢ï¼Œå®è·µæ˜¯å¦ä¸€æ–¹é¢ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šæ•´ç†ä¸€äº›åœ¨ä¸šåŠ¡ä¸­å‡çº§PWAæ—¶ç¢°åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚</p>

<h2 id="toc_12">å‚è€ƒèµ„æ–™</h2>

<ul>
<li><a href="https://wicg.github.io/BackgroundSync/spec/">Web Background Synchronization</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/SyncManager">MDN: SyncManager</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/SyncManager/register">MDN: SyncManager.register()</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/SyncRegistration">MDN: SyncRegistration</a></li>
<li><a href="https://developers.google.com/web/updates/2015/12/background-sync">Introducing Background Sync</a></li>
</ul>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15288038664515.html"  title="Previous Post: ã€PWAå­¦ä¹ ä¸å®è·µã€‘(9)ç”Ÿäº§ç¯å¢ƒä¸­PWAå®è·µçš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ">&laquo; ã€PWAå­¦ä¹ ä¸å®è·µã€‘(9)ç”Ÿäº§ç¯å¢ƒä¸­PWAå®è·µçš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15288037747207.html" 
	        title="Next Post: ã€æ€§èƒ½ä¼˜åŒ–å®è·µã€‘ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦">ã€æ€§èƒ½ä¼˜åŒ–å®è·µã€‘ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦ &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15288038009038.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    


  </body>
</html>
