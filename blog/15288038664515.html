<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  【PWA学习与实践】(9)生产环境中PWA实践的问题与解决方案 - AlienZHOU's blog
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="AlienZHOU's blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">AlienZHOU's blog</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; AlienZHOU's blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>PWA</label></li>

          
            <li><a title="【PWA学习与实践】(9)生产环境中PWA实践的问题与解决方案" href="15288038664515.html">【PWA学习与实践】(9)生产环境中PWA实践的问题与解决方案</a></li>
          
            <li><a title="【PWA学习与实践】(8)使用Service Worker进行后台同步 - Background Sync" href="15288038009038.html">【PWA学习与实践】(8)使用Service Worker进行后台同步 - Background Sync</a></li>
          
            <li><a title="【PWA学习与实践】(7)使用Notification API来进行消息提醒" href="15288036503920.html">【PWA学习与实践】(7)使用Notification API来进行消息提醒</a></li>
          
            <li><a title="【PWA学习与实践】(6) 在Chrome中调试你的PWA" href="15288035758780.html">【PWA学习与实践】(6) 在Chrome中调试你的PWA</a></li>
          
            <li><a title="【PWA学习与实践】(5)在Web中进行服务端消息推送" href="15288030176091.html">【PWA学习与实践】(5)在Web中进行服务端消息推送</a></li>
          
            <li><a title="【PWA学习与实践】(4) 解决FireBase login验证失败问题" href="15235166926023.html">【PWA学习与实践】(4) 解决FireBase login验证失败问题</a></li>
          
            <li><a title="【PWA学习与实践】(3) 让你的WebApp离线可用" href="15235151669706.html">【PWA学习与实践】(3) 让你的WebApp离线可用</a></li>
          
            <li><a title="【PWA学习与实践】(2) 使用Manifest，让你的WebApp更“Native”" href="15235140795593.html">【PWA学习与实践】(2) 使用Manifest，让你的WebApp更“Native”</a></li>
          
            <li><a title="【PWA学习与实践】(1) 2018，开始你的PWA学习之旅" href="15235138633619.html">【PWA学习与实践】(1) 2018，开始你的PWA学习之旅</a></li>
          

      
        <li class="divider"></li>
        <li><label>React</label></li>

          
            <li><a title="基于react技术栈的单页应用(SPA)搭建_快速入门实践" href="15236392559880.html">基于react技术栈的单页应用(SPA)搭建_快速入门实践</a></li>
          
            <li><a title="在react-router4中进行代码拆分（基于webpack）" href="15235187668595.html">在react-router4中进行代码拆分（基于webpack）</a></li>
          

      
        <li class="divider"></li>
        <li><label>CSS</label></li>

          
            <li><a title="【CSS模块化】(3) 使用💅styled-components来优化react组件开发" href="15236398426783.html">【CSS模块化】(3) 使用💅styled-components来优化react组件开发</a></li>
          
            <li><a title="【CSS模块化】(2) BEM命名方法论——使用BEM-constructor构建CSS" href="15236396803035.html">【CSS模块化】(2) BEM命名方法论——使用BEM-constructor构建CSS</a></li>
          
            <li><a title="【CSS模块化】(1) webpack之Local Scope" href="15236395841604.html">【CSS模块化】(1) webpack之Local Scope</a></li>
          

      
        <li class="divider"></li>
        <li><label>Server</label></li>

          
            <li><a title="【MongoDB高可用】复制集Replica Set使用简介" href="15236400113573.html">【MongoDB高可用】复制集Replica Set使用简介</a></li>
          

      
        <li class="divider"></li>
        <li><label>Automation</label></li>

          
            <li><a title="Gulp.js实践详解__基于Gulp的多页面应用实践指南" href="15236401468681.html">Gulp.js实践详解__基于Gulp的多页面应用实践指南</a></li>
          

      
        <li class="divider"></li>
        <li><label>FE else</label></li>

          
            <li><a title="各类“服务器推”技术原理与实例（Polling/COMET/SSE/WebSocket）" href="15288039493853.html">各类“服务器推”技术原理与实例（Polling/COMET/SSE/WebSocket）</a></li>
          
            <li><a title="浏览器同源策略与ajax跨域方法汇总" href="15236404711802.html">浏览器同源策略与ajax跨域方法汇总</a></li>
          
            <li><a title="JavaScript异步编程__“回调地狱”的一些解决方案" href="15236403350295.html">JavaScript异步编程__“回调地狱”的一些解决方案</a></li>
          
            <li><a title="js控制input框内光标位置（setSelectionRange详解）" href="15236405992551.html">js控制input框内光标位置（setSelectionRange详解）</a></li>
          

      
        <li class="divider"></li>
        <li><label>Reading</label></li>

          
            <li><a title="推荐阅读 2018.06" href="15288017709756.html">推荐阅读 2018.06</a></li>
          
            <li><a title="推荐阅读 2018.05" href="15287963471356.html">推荐阅读 2018.05</a></li>
          
            <li><a title="推荐阅读 2018.04" href="15283399559020.html">推荐阅读 2018.04</a></li>
          
            <li><a title="推荐阅读 2018.03" href="15282529256902.html">推荐阅读 2018.03</a></li>
          

      
        <li class="divider"></li>
        <li><label>Performace</label></li>

          
            <li><a title="【性能优化实践】优化打包策略提升页面加载速度" href="15288037747207.html">【性能优化实践】优化打包策略提升页面加载速度</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>PWA</span></li>
                        
                          <li><a title="【PWA学习与实践】(9)生产环境中PWA实践的问题与解决方案" href="15288038664515.html">【PWA学习与实践】(9)生产环境中PWA实践的问题与解决方案</a></li>
                        
                          <li><a title="【PWA学习与实践】(8)使用Service Worker进行后台同步 - Background Sync" href="15288038009038.html">【PWA学习与实践】(8)使用Service Worker进行后台同步 - Background Sync</a></li>
                        
                          <li><a title="【PWA学习与实践】(7)使用Notification API来进行消息提醒" href="15288036503920.html">【PWA学习与实践】(7)使用Notification API来进行消息提醒</a></li>
                        
                          <li><a title="【PWA学习与实践】(6) 在Chrome中调试你的PWA" href="15288035758780.html">【PWA学习与实践】(6) 在Chrome中调试你的PWA</a></li>
                        
                          <li><a title="【PWA学习与实践】(5)在Web中进行服务端消息推送" href="15288030176091.html">【PWA学习与实践】(5)在Web中进行服务端消息推送</a></li>
                        
                          <li><a title="【PWA学习与实践】(4) 解决FireBase login验证失败问题" href="15235166926023.html">【PWA学习与实践】(4) 解决FireBase login验证失败问题</a></li>
                        
                          <li><a title="【PWA学习与实践】(3) 让你的WebApp离线可用" href="15235151669706.html">【PWA学习与实践】(3) 让你的WebApp离线可用</a></li>
                        
                          <li><a title="【PWA学习与实践】(2) 使用Manifest，让你的WebApp更“Native”" href="15235140795593.html">【PWA学习与实践】(2) 使用Manifest，让你的WebApp更“Native”</a></li>
                        
                          <li><a title="【PWA学习与实践】(1) 2018，开始你的PWA学习之旅" href="15235138633619.html">【PWA学习与实践】(1) 2018，开始你的PWA学习之旅</a></li>
                        

                    
                      <li class="side-title"><span>React</span></li>
                        
                          <li><a title="基于react技术栈的单页应用(SPA)搭建_快速入门实践" href="15236392559880.html">基于react技术栈的单页应用(SPA)搭建_快速入门实践</a></li>
                        
                          <li><a title="在react-router4中进行代码拆分（基于webpack）" href="15235187668595.html">在react-router4中进行代码拆分（基于webpack）</a></li>
                        

                    
                      <li class="side-title"><span>CSS</span></li>
                        
                          <li><a title="【CSS模块化】(3) 使用💅styled-components来优化react组件开发" href="15236398426783.html">【CSS模块化】(3) 使用💅styled-components来优化react组件开发</a></li>
                        
                          <li><a title="【CSS模块化】(2) BEM命名方法论——使用BEM-constructor构建CSS" href="15236396803035.html">【CSS模块化】(2) BEM命名方法论——使用BEM-constructor构建CSS</a></li>
                        
                          <li><a title="【CSS模块化】(1) webpack之Local Scope" href="15236395841604.html">【CSS模块化】(1) webpack之Local Scope</a></li>
                        

                    
                      <li class="side-title"><span>Server</span></li>
                        
                          <li><a title="【MongoDB高可用】复制集Replica Set使用简介" href="15236400113573.html">【MongoDB高可用】复制集Replica Set使用简介</a></li>
                        

                    
                      <li class="side-title"><span>Automation</span></li>
                        
                          <li><a title="Gulp.js实践详解__基于Gulp的多页面应用实践指南" href="15236401468681.html">Gulp.js实践详解__基于Gulp的多页面应用实践指南</a></li>
                        

                    
                      <li class="side-title"><span>FE else</span></li>
                        
                          <li><a title="各类“服务器推”技术原理与实例（Polling/COMET/SSE/WebSocket）" href="15288039493853.html">各类“服务器推”技术原理与实例（Polling/COMET/SSE/WebSocket）</a></li>
                        
                          <li><a title="浏览器同源策略与ajax跨域方法汇总" href="15236404711802.html">浏览器同源策略与ajax跨域方法汇总</a></li>
                        
                          <li><a title="JavaScript异步编程__“回调地狱”的一些解决方案" href="15236403350295.html">JavaScript异步编程__“回调地狱”的一些解决方案</a></li>
                        
                          <li><a title="js控制input框内光标位置（setSelectionRange详解）" href="15236405992551.html">js控制input框内光标位置（setSelectionRange详解）</a></li>
                        

                    
                      <li class="side-title"><span>Reading</span></li>
                        
                          <li><a title="推荐阅读 2018.06" href="15288017709756.html">推荐阅读 2018.06</a></li>
                        
                          <li><a title="推荐阅读 2018.05" href="15287963471356.html">推荐阅读 2018.05</a></li>
                        
                          <li><a title="推荐阅读 2018.04" href="15283399559020.html">推荐阅读 2018.04</a></li>
                        
                          <li><a title="推荐阅读 2018.03" href="15282529256902.html">推荐阅读 2018.03</a></li>
                        

                    
                      <li class="side-title"><span>Performace</span></li>
                        
                          <li><a title="【性能优化实践】优化打包策略提升页面加载速度" href="15288037747207.html">【性能优化实践】优化打包策略提升页面加载速度</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>【PWA学习与实践】(9)生产环境中PWA实践的问题与解决方案</h1>

<p>本文是《PWA学习与实践》系列的第九篇文章。</p>

<p>PWA作为时下最火热的技术概念之一，对提升Web应用的安全、性能和体验有着很大的意义，非常值得我们去了解与学习。</p>

<p>本系列文章《PWA学习与实践》会逐步拆解PWA背后的各项技术，通过实例代码来讲解这些技术的应用方式。也正是因为PWA中技术点众多、知识细碎，因此我在学习过程中，进行了整理，并产出了《PWA学习与实践》系列文章，希望能带大家全面了解PWA中的各项技术。对PWA感兴趣的朋友欢迎关注。</p>

<h2 id="toc_0">引言</h2>

<p>在前八篇文章中，我已经介绍了一些PWA中的常见技术与使用方式。虽然我们已经学习了很多相关知识，但是，还是有很多问题在实践时才会暴露出来。这篇文章是一篇TroubleShooting，总结了我近期在PWA实践过程中遇到了一些问题，以及这些问题的解决方案。希望能帮助一些遇到类似问题的朋友。</p>

<h2 id="toc_1">1. Service Worker Scope</h2>

<blockquote>
<p>注意Service Worker注册时的作用范围（scope）</p>
</blockquote>

<h3 id="toc_2">1.1. 遇到的问题</h3>

<p>我在页面<code>/home</code>下注册了Service Worker：</p>

<pre><code class="language-javascript">navigator.serviceWorker.register(&#39;/static/home/js/sw.js&#39;)
</code></pre>

<p>通过在<code>.then()</code>中调用<code>console.log()</code>可以发现Service Worker其实注册成功了，但是在页面中却不生效。这是为什么呢？</p>

<h3 id="toc_3">1.2. 产生的原因</h3>

<p>我在前几篇介绍Service Worker的文章中没有过多强调Scope的概念：</p>

<blockquote>
<p>scope: A USVString representing a URL that defines a service worker&#39;s registration scope; what range of URLs a service worker can control. This is usually a relative URL. The default value is the URL you&#39;d get if you resolved &#39;./&#39; using the service worker script&#39;s location as the base.</p>
</blockquote>

<p>Scope规定了Service Worker的作用（URL）范围。例如，一个注册在<code>https://www.sample.com/list</code>路径下的Service Worker，其作用的范围只能是它本身与它的子路径：</p>

<ul>
<li><code>https://www.sample.com/list</code></li>
<li><code>https://www.sample.com/list/book</code></li>
<li><code>https://www.sample.com/list/book/comic</code></li>
</ul>

<p>而在<code>https://www.sample.com</code>、<code>https://www.sample.com/book</code>这些路径下则是无效的。</p>

<p>同时，scope的默认值为<code>./</code>（注意，这里所有的相对路径不是相对于页面，而是相对于sw.js脚本的）。因此，<code>navigator.serviceWorker.register(&#39;/static/home/js/sw.js&#39;)</code>代码中的scope实际上是<code>/static/home/js</code>，Service Worker也就注册在了<code>/static/home/js</code>路径下，显然无法在<code>/home</code>下生效。</p>

<p>这种情况非常常见：我们会把<code>sw.js</code>这样的文件放置在项目的静态目录下（例如文中的<code>/static/home/js</code>），而并非页面路径下。显然，要解决这个问题需要设置相应的scope。</p>

<p>然而，另一个问题出现了。如果你直接将scope设置为<code>/home</code>：</p>

<pre><code class="language-javascript">navigator.serviceWorker.register(&#39;/static/home/js/sw.js&#39;, {scope: &#39;/home&#39;})
</code></pre>

<p>在chrome控制台会看到如下的错误提示：</p>

<pre><code>Uncaught (in promise) DOMException: Failed to register a ServiceWorker: The path of the provided scope (&#39;/home&#39;) is not under the max scope allowed (&#39;/static/home/js/&#39;). 
Adjust the scope, move the Service Worker script, or use the Service-Worker-Allowed HTTP header to allow the scope.
</code></pre>

<p>StackOverflow上对此的解释是：</p>

<blockquote>
<p>Service workers can only intercept requests originating in the scope of the current directory that the service worker script is located in and its subdirectories.</p>
</blockquote>

<p>简单来说，Service Worker只允许注册在Service Worker脚本所处的路径及其子路径下。显然，我上面的代码触碰到了这个规则。那怎么办呢？</p>

<h3 id="toc_4">1.3. 解决方案</h3>

<p>解决这个问题的方式主要有两种。</p>

<h4 id="toc_5">方法一：修改路由，让sw.js的访问路径处于合适的位置</h4>

<pre><code class="language-javascript">router.get(&#39;/sw.js&#39;, function (req, res) {
    res.sendFile(path.join(__dirname, &#39;../../static/kspay-home/static/js/sw/&#39;, &#39;sw.js&#39;));
});
</code></pre>

<p>以上是一个express中简单的路由。通过路由设置，我们将Service Worker脚本路径置于根目录下，这样就可以设置scope为<code>/home</code>而不会违反其规则了：</p>

<pre><code class="language-javascript">navigator.serviceWorker
    .register(&#39;/static/home/js/sw.js&#39;, {
        scope: &#39;/home&#39;
    })
</code></pre>

<h4 id="toc_6">方法二：添加<code>Service-Worker-Allowed</code>响应头</h4>

<p>scope的规范有时候过于严格了。因此，浏览器也提供了一种方式来使我们可以越过这种限制。方法就是设置<code>Service-Worker-Allowed</code>响应头。</p>

<p>以express中的静态服务中间件serve-static为例，<a href="https://github.com/expressjs/serve-static#options">进行相应配置</a>：</p>

<pre><code class="language-javascript">options: {
    maxAge: 0,
    setHeaders: function (res, path, stat) {
        // 添加Service-Worker-Allowed，扩展service worker的scope
        if (/\/sw\/.+\.js/.test(path)) {
            res.set({
                &#39;Content-Type&#39;: &#39;application/javascript&#39;,
                &#39;Service-Worker-Allowed&#39;: &#39;/home&#39;
            });
        }
    }
}
</code></pre>

<h2 id="toc_7">2. CORS</h2>

<blockquote>
<p>跨域资源的缓存报错</p>
</blockquote>

<h3 id="toc_8">2.1. 遇到的问题</h3>

<p>在《【PWA学习与实践】(3) 让你的WebApp离线可用》中我介绍了如何用Service Worker进行缓存以实现离线功能。其中，为了提高体验，我们会在Service Worker安装时缓存静态文件，实现这一功能的部分代码如下：</p>

<pre><code class="language-javascript">// 监听install事件，安装完成后，进行文件缓存
self.addEventListener(&#39;install&#39;, e =&gt; {
    var cacheOpenPromise = caches.open(cacheName).then(function (cache) {
        return cache.addAll(cacheFiles);
    });
    e.waitUntil(cacheOpenPromise);
});
</code></pre>

<p><code>cacheFiles</code>就是需要缓存的静态文件列表。然而Service Worker运行后，在application tab中发现<code>cacheFiles</code>的静态资源并未被缓存下来。</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/26/1639b2f3954721b0?w=620&amp;h=200&amp;f=png&amp;s=18505" alt=""/></p>

<h3 id="toc_9">2.2. 产生的原因</h3>

<p>切换到Console可以看到类似如下的报错信息：</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/26/1639b385aac7ce3c?w=757&amp;h=69&amp;f=png&amp;s=32044" alt=""/></p>

<p>前端同学对这个问题非常熟悉：<strong>跨域问题</strong>。</p>

<p>为了使我们的页面能够顺利加载CDN等外站资源，浏览器在<code>script</code>、<code>link</code>、<code>img</code>等标签上放松了跨域限制。这使得我们在页面中通过<code>script</code>标签来加载javascript脚本是不会导致跨域问题的（经典的jsonp就是以此为基础实现的）。</p>

<p>然而在Service Worker中使用<code>cache.addAll()</code>则会通过类似fetch请求的方式来获取资源（类似在页面中使用XHR请求外站脚本），是会受到跨域资源策略限制而无法缓存到本地的。</p>

<p>在实际生产环境中，为了缩短请求的响应时间与、减轻服务器压力，通常我们都会将javascript、css、image这些静态资源通过CDN进行分发，或者将其放置在一些独立的静态服务集群中。所以线上的静态资源基本都是“跨站资源”。</p>

<h3 id="toc_10">2.3. 解决方案</h3>

<p>该问题其实不算是Service Worker中的特定问题，解决方式和处理一般的跨域问题类似，可以设置<code>Access-Control-Allow-Origin</code>响应头来解决。</p>

<ul>
<li>如果使用CDN，可以在CDN服务中进行配置。一般的CDN服务是会支持配置HTTP响应头的；</li>
<li>如果使用自己搭建的静态服务器集群，可以对服务器进行相应配置。这里有一个<a href="https://github.com/h5bp/server-configs">仓库</a>包含ngix、apache、iis等常用服务器的配置，可以参考。</li>
</ul>

<h2 id="toc_11">3. iOS standalone 模式</h2>

<blockquote>
<p>iOS standalone模式下的特殊处理</p>
</blockquote>

<h3 id="toc_12">3.1. 遇到的问题</h3>

<p>今年年初Apple宣布在iOS safari 11.3中支持Service Worker，这对PWA的推广起到了重要的作用，让我们可以“跨平台”来实现PWA技术。</p>

<p>虽然，iOS safari不支持manifest配置来实现添加到桌面，但是我在《【PWA学习与实践】(2) 使用Manifest，让你的WebApp更“Native”》中介绍了如何用safari自有的meta标签来实现standalone模式。</p>

<p>不过，问题就出在了standalone模式上。抛开iOS safari standalone模式现有的一些其他小bug（包括状态栏的显示、白屏、重复添加等），iOS safari standalone模式有一个无法回避的重大问题。其源于iOS与android的一个重要区别：</p>

<p>iOS没有后退键，而一般android机都有。</p>

<p>在iOS上使用standalone模式添加的应用，由于没有浏览器的工具栏，所以无法进行后退。例如我打开首页，然后点击首页课程列表中的一门课程后，浏览器跳转到课程页，由于iOS没有后退键，所以你无法再回到首页，除非杀死“应用”重新启动。</p>

<h3 id="toc_13">3.2. 产生的原因</h3>

<p>正如上面所提到的，由于iOS没有后退键，而standalone模式会隐藏浏览器工具条和导航条，因此，在iOS中使用保存到桌面的WebApp，就像是一次不能回头的旅行……</p>

<h3 id="toc_14">3.3. 解决方案</h3>

<p>显然，这种体验是无法接受的。目前我采用的解决方案非常简单，在打开页面时进行判断，如果是iOS中的standalone模式，则在页面右上角显示一个“返回”小图标。点击图标返回上一个页面。</p>

<p>iOS中有一个专门的属性来判断是否为standalone模式：</p>

<pre><code class="language-javascript">if (&#39;standalone&#39; in window.navigator &amp;&amp; window.navigator.standalone) {
    // standalone模式进行特殊处理，例如展示返回按钮
    backBtn.show();
}
</code></pre>

<p>使用history API即可实现按钮的后退功能：</p>

<pre><code class="language-javascript">backBtn.addEventListener(&#39;click&#39;, function () {
    window.history.back();
});
</code></pre>

<h2 id="toc_15">4. 图片策略</h2>

<blockquote>
<p>解决PWA离线资源中非缓存图片资源的展示</p>
</blockquote>

<h3 id="toc_16">4.1. 遇到的问题</h3>

<p>在实际使用中，为了满足一定的离线功能，我缓存了一些变化频率极小的API数据，例如个人中心里的列表信息。而列表中包含了较多的图片。为了节省了用户的存储空间，对于图片资源我并未选择缓存。</p>

<p>这导致了一个问题：离线情况下，虽然用户能正常看到列表信息，但是其中的图片部分都是类似下面这种“图裂了”的情况，体验不太好。</p>

<p><img src="https://user-gold-cdn.xitu.io/2018/5/25/16397f563295ef0e?w=1422&amp;h=470&amp;f=png&amp;s=27924" alt=""/></p>

<h3 id="toc_17">4.2. 产生的原因</h3>

<p>原因上面已经解释了，离线状态下无法请求到图片资源，所以在一些浏览器中就会表现出这种“图挂了”的状态。</p>

<h3 id="toc_18">4.3. 解决方案</h3>

<p>解决这个体验问题的大致思路如下：</p>

<ol>
<li>首先，需要在本地缓存占位图资源</li>
<li>其次，在获取图片时判断是否出现错误</li>
<li>最后，在错误时使用占位图进行替换</li>
</ol>

<p>由于只是缓存占位图，而占位图一般较为固定，只会有有限的几种尺寸样式，因此不会产生太多缓存空间的占用。占位图的缓存完全可以在缓存静态资源时一起进行。</p>

<p>而图片获取出错（可能是网络原因，也可能是URL错误）时，进行占位图的替换有两种简单的方式：</p>

<p><strong>方法一：在fetch事件中监听图片资源，出错时使用占位图</strong></p>

<pre><code class="language-javascript">self.addEventListener(&#39;fetch&#39;, e =&gt; {
    if (/\.png|jpeg|jpg|gif/i.test(e.request.url)) {
        e.respondWith(
            fetch(e.request).then(response =&gt; {
                return response;
            }).catch(err =&gt; {
                // 请求错误时使用占位图
                return caches.match(placeholderPic).then(cache =&gt; cache);
            })
        );
        return;
    }
</code></pre>

<p><strong>方法二：通过img标签的onerror属性来请求占位图</strong></p>

<p>先将img标签改为</p>

<pre><code class="language-HTML">&lt;img class=&quot;list-cover&quot;
    src=&quot;//your.sample.com/1234.png&quot;
    alt=&quot;{{ item.desc }}&quot;
    onerror=&quot;javascript:this.src=&#39;https://your.sample.com/placeholder.png&#39;&quot;/&gt;   
</code></pre>

<p><code>onerror</code>属性中指定的方法会在图片加载错误时替换<code>src</code>；同时我们将Service Worker中的代码进行调整：</p>

<pre><code class="language-javascript">self.addEventListener(&#39;fetch&#39;, e =&gt; {
    if (/\.png|jpeg|jpg|gif/i.test(e.request.url)) {
        e.respondWith(
            fetch(e.request).then(response =&gt; {
                return response;
            // 触发onerror后，img会再次请求图片placeholder.png
            // 由于无网络连接，此fetch依然会出错
            }).catch(err =&gt; {
                // 由于我们事先缓存了placeholder.png，这里会返回缓存结果
                return caches.match(e.request).then(cache =&gt; cache);
            })
        );
        return;
    }
</code></pre>

<h2 id="toc_19">5. 写在最后</h2>

<p>本文总结了一些我在进行PWA升级实践中遇到的问题，希望对遇到类似问题的朋友能够有一些启发或帮助。</p>

<p>在下一篇文章中，我会回到PWA相关技术，介绍Resource Hint，以及如何使用Resource Hint来提高页面的加载性能，提升用户体验。</p>

<h2 id="toc_20">参考资料</h2>

<h3 id="toc_21">Service Worker Scope</h3>

<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ServiceWorkerContainer/register#%E5%8F%82%E6%95%B0">Service Worker Scope (MDN)</a></li>
<li><a href="https://stackoverflow.com/questions/35780397/understanding-service-worker-scope">Understanding Service Worker scope</a></li>
<li><a href="https://stackoverflow.com/questions/49084718/how-exactly-add-service-worker-allowed-to-register-service-worker-scope-in-upp">How exactly add “Service-Worker-Allowed” to register service worker scope in upper folder</a></li>
</ul>

<h3 id="toc_22">CORS</h3>

<ul>
<li><a href="https://stackoverflow.com/questions/39109789/what-limitations-apply-to-opaque-responses">What limitations apply to opaque responses?
</a></li>
<li><a href="https://developers.google.com/web/tools/workbox/guides/handle-third-party-requests">Handle Third Party Requests</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_settings_attributes">CORS settings attributes</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing (CORS)</a></li>
<li><a href="https://github.com/h5bp/server-configs">Git Repo: server configs</a></li>
</ul>

<h3 id="toc_23">iOS standalone</h3>

<ul>
<li><a href="https://medium.com/@firt/dont-use-ios-web-app-meta-tag-irresponsibly-in-your-progressive-web-apps-85d70f4438cb">Don’t use iOS meta tags irresponsibly in your Progressive Web Apps</a></li>
</ul>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15288039493853.html"  title="Previous Post: 各类“服务器推”技术原理与实例（Polling/COMET/SSE/WebSocket）">&laquo; 各类“服务器推”技术原理与实例（Polling/COMET/SSE/WebSocket）</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15288038009038.html" 
	        title="Next Post: 【PWA学习与实践】(8)使用Service Worker进行后台同步 - Background Sync">【PWA学习与实践】(8)使用Service Worker进行后台同步 - Background Sync &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15288038664515.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    


  </body>
</html>
